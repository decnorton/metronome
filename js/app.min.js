$(function(){var e;try{e=new webkitAudioContext;console.log("Supported")}catch(t){alert("Web Audio API is not supported in this browser")}if(e){var n=function(e){this.context=e;this.loaded=!1;this.clickBuffer=null;this.tempo=180;this.beats=4;this.volume=1;this.loop=null;this.counter=0;this.loadSound()};n.prototype={loadSound:function(){var t=new XMLHttpRequest;t.open("GET","/sounds/metronome.wav",!0);t.responseType="arraybuffer";t.onload=function(){e.decodeAudioData(t.response,function(e){this.clickBuffer=e;this.loaded=!0},function(){console.log("Error")})};t.send()},play:function(){if(!this.clickBuffer)return;var t="green",n=e.createBufferSource(),i=e.createGainNode();i.gain.value=r.volume*r.volume;n.buffer=clickBuffer;n.connect(i);if(r.counter%r.beats==0){r.counter=0;n.playbackRate.value=1.5;t="red"}i.connect(e.destination);n.noteOn(0);$(".indicator").addClass(t);setTimeout(function(){$(".indicator").removeClass("green red")},100);r.counter++},start:function(){$(".toggle").html("Stop").addClass("playing");if(this.loop!=null)console.log("Already running");else{console.log("Start");var e=6e4/this.tempo;this.loop=setInterval(this.play,e)}},stop:function(){$(".toggle").html("Start").removeClass("playing");console.log("Stop");clearInterval(this.loop);this.loop=null;r.counter=0},toggle:function(){this.loop==null?this.start():this.stop()},changeTempo:function(e){if(e<=0||e==this.tempo)return;this.tempo=e;console.log("Changed tempo: "+e);$(".tempo").val(e);if(this.loop!=null){this.stop();this.start()}},changeBeats:function(e){if(e<=0)return;$(".beats").val(e);this.beats=e},changeVolume:function(e){$('[type="number"].volume').val(e*100);this.volume=e}};var r=new n(e);$(document).on("keydown",function(e){if(e.keyCode==32){if(e.srcElement.nodeName=="INPUT")return;r.toggle()}});function i(e){e.keyCode==13&&$(this).blur();if(e.keyCode==46||e.keyCode==8||e.keyCode==9||e.keyCode==27||e.keyCode==13||e.keyCode==65&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39)return;(e.shiftKey||(e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105))&&e.preventDefault()}function s(e){var t=(new Date).getTime()/1e3,n=parseInt(t,10);return e?t:Math.round((t-n)*1e3)/1e3+" "+n}var o=0,u=s(),a=null;$(".tempo").val(r.tempo).on("keydown",i).on("change",function(e){$(this).prop("type")=="range"&&$('[type="number"].tempo').val($(this).val());var t=s(!0),n=this;clearTimeout(a);a=setTimeout(function(){if(u>t)return;r.changeTempo(parseInt($(n).val()))},1e3)}).on("");$(".beats").val(r.beats).on("keydown",i).on("change",function(e){r.changeBeats(parseInt($(this).val()))});$(".volume").val(r.volume*100).on("keydown",i).on("change",function(e){var t=parseInt($(this).val())/parseInt($(this).prop("max"));console.log(t);r.changeVolume(t)});$(".toggle").on("click",function(e){r.toggle()});$('input[type="number"]').on("click",function(e){$(this).select()})}});